name: Line Contribution Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Run blame line counter
      run: python ./src/metrics/blame_line_counter.py
    
    - name: Send Discord notification
      run: |
        report_date=$(date +%Y-%m-%d)
        message="ðŸ“Š **BÃ¡o cÃ¡o Ä‘Ã³ng gÃ³p dÃ²ng code** ($report_date):"

        tail -n +2 ./src/metrics/line_contribution.csv | while IFS=',' read -r _raw_date _author _lines; do
          author=$(echo "$_author" | sed 's/[",]//g' | xargs)      # remove " , and trim spaces
          lines=$(echo "$_lines" | sed 's/[^0-9]//g')              # keep only digits
          message="$message\n- \`$author\`: $lines dÃ²ng"
        done

        echo -e "$message"

        payload=$(jq -Rn --arg msg "$message" '{content: $msg}')

        curl -H "Content-Type: application/json" \
              -X POST \
              -d "$payload" \
              $DISCORD_WEBHOOK
      env:
        DISCORD_WEBHOOK: https://discord.com/api/webhooks/1401911119290961962/PGaNzn5IWIiOgixqCCzMPfNsIoWaj77rTqh7W7MFfwc87ezxfhr-ZMTwWUQQ83hH1Y3E


