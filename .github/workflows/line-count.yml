name: Line Contribution Report

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Láº¥y toÃ n bá»™ history cho git blame

      - name: CÃ i jq (náº¿u chÆ°a cÃ³)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: TÃ­nh sá»‘ dÃ²ng Ä‘Ã³ng gÃ³p báº±ng git
        run: |
          echo "ðŸ“Š **BÃ¡o cÃ¡o Ä‘Ã³ng gÃ³p dÃ²ng code** ($(date +%Y-%m-%d)):" > report.txt

          # XÃ³a file táº¡m náº¿u cÃ³
          rm -f authors.txt authors_count.txt

          # Láº¥y táº¥t cáº£ file do git quáº£n lÃ½ (khÃ´ng giá»›i háº¡n Ä‘uÃ´i)
          git ls-files | while read file; do
            git blame --line-porcelain "$file" | grep "^author " >> authors.txt || true
          done

          # Äáº¿m vÃ  lá»c tÃ¡c giáº£
          sort authors.txt | uniq -c | sort -nr > authors_count.txt

          # Format káº¿t quáº£
          while read count author_raw; do
            author=$(echo "$author_raw" | sed 's/^ *//; s/["'\'']//g')
            echo "- \`$author\`: $count dÃ²ng" >> report.txt
          done < authors_count.txt

          cat report.txt

      - name: Gá»­i bÃ¡o cÃ¡o Ä‘áº¿n Discord
        run: |
          message=$(cat report.txt)
          payload=$(jq -Rn --arg msg "$message" '{content: $msg}')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$payload" \
               "$DISCORD_WEBHOOK"
        env:
          DISCORD_WEBHOOK: https://discord.com/api/webhooks/1401911119290961962/PGaNzn5IWIiOgixqCCzMPfNsIoWaj77rTqh7W7MFfwc87ezxfhr-ZMTwWUQQ83hH1Y3E
