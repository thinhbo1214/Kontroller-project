name: Line Contribution Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Run blame line counter
      run: python ./src/metrics/blame_line_counter.py
    
    - name: Send Discord notification
      run: |
        report_date=$(date +%Y-%m-%d)
        message="üìä **B√°o c√°o ƒë√≥ng g√≥p d√≤ng code** ($report_date):"

        if [ ! -f ./src/metrics/line_contribution.csv ]; then
          echo "‚ùå Kh√¥ng t√¨m th·∫•y file CSV!"
          exit 1
        fi

        tail -n +2 ./src/metrics/line_contribution.csv | while IFS=',' read -r date author lines; do
          # N·∫øu b·∫•t k·ª≥ d√≤ng n√†o kh√¥ng ƒë·ªß 3 c·ªôt s·∫Ω b·ªã b·ªè qua
          if [[ -z "$author" || -z "$lines" ]]; then continue; fi

          sanitized_author=$(echo "$author" | tr -d '"' | sed 's/,/ /g')
          message="$message\n- \`$sanitized_author\`: $lines d√≤ng"
        done

        echo -e "$message"  # G·ª≠i log ra console tr∆∞·ªõc

        payload=$(jq -Rn --arg msg "$message" '{content: $msg}')

        curl -H "Content-Type: application/json" \
             -X POST \
             -d "$payload" \
             "$DISCORD_WEBHOOK"
      env:
        DISCORD_WEBHOOK: https://discord.com/api/webhooks/1401911119290961962/PGaNzn5IWIiOgixqCCzMPfNsIoWaj77rTqh7W7MFfwc87ezxfhr-ZMTwWUQQ83hH1Y3E


