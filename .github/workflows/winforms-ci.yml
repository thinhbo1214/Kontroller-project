name: Build Server Winform Kontroller App  # TÃªn cá»§a workflow hiá»ƒn thá»‹ trÃªn GitHub Actions

on:
  push:
    branches: [ main ]  # KÃ­ch hoáº¡t workflow khi cÃ³ push lÃªn nhÃ¡nh main
    paths:
      - 'src/Server/**'  # Chá»‰ kÃ­ch hoáº¡t khi cÃ³ thay Ä‘á»•i trong thÆ° má»¥c src/Server
      - '.github/workflows/**'

jobs:
  build:
    runs-on: windows-latest  # Sá»­ dá»¥ng mÃ´i trÆ°á»ng Windows má»›i nháº¥t trÃªn GitHub

    steps:
    - name: Láº¥y mÃ£ nguá»“n  # BÆ°á»›c checkout mÃ£ nguá»“n tá»« repo
      uses: actions/checkout@v3  # Sá»­ dá»¥ng action checkout phiÃªn báº£n 3

    # - name: CÃ i .NET SDK
    #   uses: actions/setup-dotnet@v4
    #   with:
    #     dotnet-version: 7.0.x  # CÃ i SDK .NET náº¿u cáº§n, hiá»‡n táº¡i project báº¡n cÃ³ thá»ƒ Ä‘Ã£ cÃ³ sáºµn

    - name: CÃ i Python & gdown  # CÃ i Python vÃ  thÆ° viá»‡n gdown Ä‘á»ƒ táº£i file tá»« Google Drive
      run: |
        python -m pip install --upgrade pip  # Cáº­p nháº­t pip
        pip install gdown  # CÃ i gdown Ä‘á»ƒ táº£i file tá»« Google Drive

    # - name: Táº£i extra_files.zip tá»« Google Drive báº±ng gdown  # DÃ¹ng gdown táº£i file zip tá»« Google Drive
    #   run: |
    #     gdown https://drive.google.com/uc?id=1m068G_SadSpKjDyL0vslfcx8GWsfVk6c  # Link file zip báº¡n Ä‘Ã£ upload lÃªn Drive

    # - name: Kiá»ƒm tra file extra_files.zip  # In ra tÃªn file zip Ä‘á»ƒ Ä‘áº£m báº£o táº£i thÃ nh cÃ´ng
    #   run: dir extra_files.zip  # DÃ¹ng lá»‡nh dir Ä‘á»ƒ liá»‡t kÃª file

    # - name: Giáº£i nÃ©n extra_files.zip  # Giáº£i nÃ©n file zip vÃ o thÆ° má»¥c extra_files
    #   run: |
    #     powershell Expand-Archive -Path extra_files.zip -DestinationPath extra_files  # DÃ¹ng PowerShell Ä‘á»ƒ giáº£i nÃ©n

    - name: Build WinForm dáº¡ng self-contained vÃ o thÆ° má»¥c BuildOutput  # BiÃªn dá»‹ch WinForm thÃ nh file thá»±c thi
      run: dotnet publish ./src/Server/Server.csproj -c Release -o ./BuildOutput --self-contained false -r win-x64
      # --self-contained false: yÃªu cáº§u mÃ¡y Ä‘Ã­ch cÃ³ .NET Runtime, nháº¹ hÆ¡n
      # --self-contained true: build kÃ¨m luÃ´n .NET Runtime, file to hÆ¡n nhÆ°ng cháº¡y má»i mÃ¡y

    - name: ThÃªm tÃ i nguyÃªn ngoÃ i vÃ o thÆ° má»¥c BuildOutput  # Copy cÃ¡c file tá»« extra_files vÃ o thÆ° má»¥c BuildOutput
      shell: powershell  # Sá»­ dá»¥ng PowerShell lÃ m shell thá»±c thi
      run: |
        if (Test-Path "./extra_files") {  # Náº¿u tá»“n táº¡i thÆ° má»¥c extra_files
          Get-ChildItem ./extra_files | ForEach-Object {
            Copy-Item $_.FullName -Destination ./BuildOutput/ -Recurse -Force  # Copy táº¥t cáº£ vÃ o BuildOutput
          }
        }

    - name: Ghi Ä‘Ã¨ báº±ng file tá»« repo náº¿u cÃ³ ./src/Server/extra_files  # Æ¯u tiÃªn ná»™i dung trong repo
      shell: pwsh  # DÃ¹ng PowerShell Core cho tÆ°Æ¡ng thÃ­ch tá»‘t hÆ¡n
      run: |
        if (Test-Path "${{ github.workspace }}/src/Server/extra_files") {
          Write-Host "ğŸ“ Found extra_files trong repo. Äang copy ghi Ä‘Ã¨ lÃªn BuildOutput..."
          Copy-Item -Path "${{ github.workspace }}/src/Server/extra_files/*" -Destination "${{ github.workspace }}/BuildOutput/" -Recurse -Force
        } else {
          Write-Host "âŒ KhÃ´ng tÃ¬m tháº¥y extra_files trong repo!"
        }

    # - name: Táº¡o file ZIP tá»« thÆ° má»¥c BuildOutput  # (TÃ¹y chá»n) Náº¿u muá»‘n nÃ©n láº¡i thÃ nh 1 file zip
    #   run: Compress-Archive -Path ./BuildOutput/* -DestinationPath ./KontrollerApp.zip

    # - name: Upload artifact KontrollerApp.zip  # (TÃ¹y chá»n) Upload file zip lÃªn GitHub
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: KontrollerApp  # TÃªn artifact
    #     path: KontrollerApp.zip  # ÄÆ°á»ng dáº«n Ä‘áº¿n file zip

    - name: Upload thÆ° má»¥c BuildOutput (GitHub tá»± zip khi táº£i vá»)  # Upload nguyÃªn thÆ° má»¥c BuildOutput lÃªn GitHub
      uses: actions/upload-artifact@v4
      with:
        name: KontrollerApp  # TÃªn artifact hiá»ƒn thá»‹
        path: BuildOutput  # ÄÆ°á»ng dáº«n Ä‘áº¿n thÆ° má»¥c chá»©a file Ä‘Ã£ build
        if-no-files-found: error  # BÃ¡o lá»—i náº¿u khÃ´ng cÃ³ file nÃ o
        retention-days: 7  # Artifact sáº½ Ä‘Æ°á»£c lÆ°u 7 ngÃ y trÃªn GitHub
